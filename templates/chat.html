{% extends "base.html" %}

{% block title %}–ß–∞—Ç —Å {{ other_user.encrypted_nickname }}{% endblock %}

{% block content %}
<style>
.chat-header {
    display: flex;
    align-items: center;
    gap: 1em;
}
.chat-header-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: var(--bg-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}
.chat-header-avatar-img {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    object-fit: cover;
    background: var(--bg-secondary);
}
</style>
<div class="container">
    <div class="chat-container">
        <div class="chat-header">
            <div class="chat-header-avatar">
                <img src="{{ url_for('static', filename=other_user.avatar or 'avatars/cybermask.svg') }}" alt="avatar" class="chat-header-avatar-img">
            </div>
            <h2>–ß–∞—Ç —Å {{ other_user.encrypted_nickname }}</h2>
            <div class="key-info">
                <button onclick="showKeyModal()">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–∞–º–∏</button>
                <a href="{{ url_for('index') }}" class="btn btn-secondary">–ù–∞–∑–∞–¥</a>
            </div>
        </div>
        
        <div class="messages-container" id="messages">
            {% for message in messages %}
            <div class="message {% if message.sender_id == current_user.id %}sent{% else %}received{% endif %}{% if message.deleted %} deleted{% endif %}">
                <div class="message-content">
                    <span class="message-text">{{ message.content.split(' [file:')[0] }}</span>
                    {% if '[file:' in message.content %}
                        {% set file_url = message.content.split('[file:')[1].split(']')[0] %}
                        {% if file_url.endswith('.png') or file_url.endswith('.jpg') or file_url.endswith('.jpeg') or file_url.endswith('.gif') or file_url.endswith('.webp') %}
                            <img src="{{ file_url }}" style="max-width:180px;max-height:180px;margin-top:8px;border-radius:8px;">
                        {% elif file_url.endswith('.mp4') or file_url.endswith('.mov') or file_url.endswith('.avi') %}
                            <video src="{{ file_url }}" controls style="max-width:220px;max-height:180px;margin-top:8px;border-radius:8px;"></video>
                        {% elif file_url.endswith('.mp3') or file_url.endswith('.wav') %}
                            <audio src="{{ file_url }}" controls style="margin-top:8px;"></audio>
                        {% else %}
                            <div style="margin-top:8px;">
                                <a href="{{ file_url }}" target="_blank" class="file-download-link">
                                    üìé –°–∫–∞—á–∞—Ç—å —Ñ–∞–π–ª
                                </a>
                            </div>
                        {% endif %}
                    {% endif %}
                    <span class="message-time">{{ message.timestamp.strftime('%H:%M') }}</span>
                </div>
            </div>
            {% endfor %}
        </div>
        
        <div class="chat-input-container">
            <form class="chat-input-form" id="messageForm" enctype="multipart/form-data">
                <div class="chat-input-group">
                    <textarea 
                        class="chat-input" 
                        id="messageInput" 
                        placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ... (Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏, Shift+Enter –¥–ª—è –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)" 
                        required
                        rows="1"
                    ></textarea>
                </div>
                <input type="file" name="file" id="fileInput" accept="image/*,video/*" style="margin-left:10px;">
                <button type="submit" class="chat-send-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </form>
        </div>
    </div>
</div>

<!-- Modal –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–ª—é—á–∞–º–∏ -->
<div id="keyModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–ª—é—á–∞–º–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è</h3>
        <div class="key-management">
            <div class="key-section">
                <h4>–¢–µ–∫—É—â–∏–π –∫–ª—é—á:</h4>
                <div class="current-key" id="currentKey">–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</div>
            </div>
            <div class="key-section">
                <h4>–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–≤—ã–π –∫–ª—é—á:</h4>
                <input type="text" id="newKey" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è" class="form-control">
                <button onclick="setKey()" class="btn btn-primary">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–ª—é—á</button>
            </div>
            <div class="key-section">
                <h4>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–ª—é—á–∞:</h4>
                <button onclick="generateKey()" class="btn btn-secondary">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π –∫–ª—é—á</button>
            </div>
            {% if show_sync_button %}
            <div class="key-section">
                <h4>–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:</h4>
                <button onclick="syncKeys()" class="btn btn-secondary">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á–∏</button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    const socket = io();
    const currentUserId = {{ current_user.id }};
    const otherUserId = {{ other_user.id }};
    const chatId = {{ chat.id }};
    let currentKey = localStorage.getItem('chat_key_' + otherUserId) || null;
    const anonymousMode = {{ 'true' if anonymous_mode else 'false' }};
    
    // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–µ–º—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ —á–∞—Ç–∞
    socket.emit('join_chat', {
        chat_id: chatId,
        user_id: currentUserId
    });
    
    // –†–∞—Å—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    async function decryptExistingMessages() {
        const messagesContainer = document.getElementById('messages');
        const messageElements = messagesContainer.querySelectorAll('.message');
        
        for (let element of messageElements) {
            const messageText = element.querySelector('.message-text');
            if (messageText && messageText.textContent !== '[–æ—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è]') {
                try {
                    const decryptedText = await decryptMessage(messageText.textContent, currentKey);
                    messageText.textContent = decryptedText;
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:', error);
                }
            }
        }
        
        // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑ –ø–æ—Å–ª–µ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // –í—ã–∑—ã–≤–∞–µ–º —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫—É –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    decryptExistingMessages();
    
    // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–ª—é—á–∞–º–∏
    function showKeyModal() {
        document.getElementById('keyModal').style.display = 'block';
    }
    
    function setKey() {
        const newKey = document.getElementById('newKey').value.trim();
        if (newKey) {
            currentKey = newKey;
            localStorage.setItem('chat_key_' + otherUserId, newKey);
            document.getElementById('currentKey').textContent = newKey;
            document.getElementById('newKey').value = '';
            document.getElementById('keyModal').style.display = 'none';
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –Ω–æ–≤—ã–º –∫–ª—é—á–æ–º
            decryptExistingMessages();
        }
    }
    
    async function generateKey() {
        try {
            const response = await fetch('/user/generate_key_json', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            const result = await response.json();
            if (result.success) {
                const newKey = result.key;
                currentKey = newKey;
                localStorage.setItem('chat_key_' + otherUserId, newKey);
                document.getElementById('currentKey').textContent = newKey;
                document.getElementById('newKey').value = newKey;
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –Ω–æ–≤—ã–º –∫–ª—é—á–æ–º
                decryptExistingMessages();
            } else {
                alert(result.message || '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–∞');
            }
        } catch (error) {
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–ª—é—á–∞');
        }
    }
    
    async function syncKeys() {
        try {
            const response = await fetch(`/chat/{{ chat.id }}/sync_keys`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            const result = await response.json();
            if (result.success) {
                const newKey = result.chat_key;
                currentKey = newKey;
                localStorage.setItem('chat_key_' + otherUserId, newKey);
                document.getElementById('currentKey').textContent = newKey;
                document.getElementById('newKey').value = newKey;
                
                // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—à–∏—Ñ—Ä–æ–≤—ã–≤–∞–µ–º –≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è —Å –Ω–æ–≤—ã–º –∫–ª—é—á–æ–º
                decryptExistingMessages();
                
                alert('–ö–ª—é—á–∏ —É—Å–ø–µ—à–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');
            } else {
                alert(result.message || '–û—à–∏–±–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∫–ª—é—á–µ–π');
            }
        } catch (error) {
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∫–ª—é—á–µ–π');
        }
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    document.querySelector('.close').addEventListener('click', function() {
        document.getElementById('keyModal').style.display = 'none';
    });
    
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('keyModal');
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    });
    
    // –§—É–Ω–∫—Ü–∏—è —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
    async function encryptMessage(text, key) {
        if (!key) return text;
        
        try {
            const encoder = new TextEncoder();
            const data = encoder.encode(text);
            
            // –°–æ–∑–¥–∞–µ–º –∫–ª—é—á –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–ª–∏–Ω—ã (256 –±–∏—Ç = 32 –±–∞–π—Ç–∞)
            let keyBytes;
            if (key.length < 32) {
                // –ï—Å–ª–∏ –∫–ª—é—á –∫–æ—Ä–æ—á–µ 32 –±–∞–π—Ç, –¥–æ–ø–æ–ª–Ω—è–µ–º –µ–≥–æ
                const keyEncoder = new TextEncoder();
                const originalKey = keyEncoder.encode(key);
                keyBytes = new Uint8Array(32);
                keyBytes.set(originalKey);
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –±–∞–π—Ç—ã –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ–º –∫–ª—é—á–∞
                for (let i = originalKey.length; i < 32; i++) {
                    keyBytes[i] = originalKey[i % originalKey.length];
                }
            } else if (key.length > 32) {
                // –ï—Å–ª–∏ –∫–ª—é—á –¥–ª–∏–Ω–Ω–µ–µ 32 –±–∞–π—Ç, –æ–±—Ä–µ–∑–∞–µ–º –µ–≥–æ
                const keyEncoder = new TextEncoder();
                const originalKey = keyEncoder.encode(key);
                keyBytes = originalKey.slice(0, 32);
            } else {
                // –ï—Å–ª–∏ –∫–ª—é—á —Ä–æ–≤–Ω–æ 32 –±–∞–π—Ç–∞
                const keyEncoder = new TextEncoder();
                keyBytes = keyEncoder.encode(key);
            }
            
            const cryptoKey = await crypto.subtle.importKey(
                'raw',
                keyBytes,
                { name: 'AES-GCM' },
                false,
                ['encrypt']
            );
            
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const encrypted = await crypto.subtle.encrypt(
                { name: 'AES-GCM', iv: iv },
                cryptoKey,
                data
            );
            
            const encryptedArray = new Uint8Array(encrypted);
            const combined = new Uint8Array(iv.length + encryptedArray.length);
            combined.set(iv);
            combined.set(encryptedArray, iv.length);
            
            return btoa(String.fromCharCode(...combined));
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è:', error);
            return text; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –µ—Å–ª–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å
        }
    }
    
    // –§—É–Ω–∫—Ü–∏—è –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è
    async function decryptMessage(encryptedText, key) {
        if (!key) return encryptedText;
        
        try {
            const combined = new Uint8Array(atob(encryptedText).split('').map(c => c.charCodeAt(0)));
            const iv = combined.slice(0, 12);
            const encrypted = combined.slice(12);
            
            // –°–æ–∑–¥–∞–µ–º –∫–ª—é—á –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–ª–∏–Ω—ã (256 –±–∏—Ç = 32 –±–∞–π—Ç–∞)
            let keyBytes;
            if (key.length < 32) {
                // –ï—Å–ª–∏ –∫–ª—é—á –∫–æ—Ä–æ—á–µ 32 –±–∞–π—Ç, –¥–æ–ø–æ–ª–Ω—è–µ–º –µ–≥–æ
                const keyEncoder = new TextEncoder();
                const originalKey = keyEncoder.encode(key);
                keyBytes = new Uint8Array(32);
                keyBytes.set(originalKey);
                // –ó–∞–ø–æ–ª–Ω—è–µ–º –æ—Å—Ç–∞–≤—à–∏–µ—Å—è –±–∞–π—Ç—ã –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ–º –∫–ª—é—á–∞
                for (let i = originalKey.length; i < 32; i++) {
                    keyBytes[i] = originalKey[i % originalKey.length];
                }
            } else if (key.length > 32) {
                // –ï—Å–ª–∏ –∫–ª—é—á –¥–ª–∏–Ω–Ω–µ–µ 32 –±–∞–π—Ç, –æ–±—Ä–µ–∑–∞–µ–º –µ–≥–æ
                const keyEncoder = new TextEncoder();
                const originalKey = keyEncoder.encode(key);
                keyBytes = originalKey.slice(0, 32);
            } else {
                // –ï—Å–ª–∏ –∫–ª—é—á —Ä–æ–≤–Ω–æ 32 –±–∞–π—Ç–∞
                const keyEncoder = new TextEncoder();
                keyBytes = keyEncoder.encode(key);
            }
            
            const cryptoKey = await crypto.subtle.importKey(
                'raw',
                keyBytes,
                { name: 'AES-GCM' },
                false,
                ['decrypt']
            );
            
            const decrypted = await crypto.subtle.decrypt(
                { name: 'AES-GCM', iv: iv },
                cryptoKey,
                encrypted
            );
            
            return new TextDecoder().decode(decrypted);
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –¥–µ—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è:', error);
            return encryptedText; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞—Ç—å
        }
    }
    
    // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É
    const messageForm = document.getElementById('messageForm');
    const messageInput = document.getElementById('messageInput');
    const fileInput = document.getElementById('fileInput');
    const messagesContainer = document.getElementById('messages');

    messageForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const text = messageInput.value.trim();
        const file = fileInput.files[0];
        if (!text && !file) return;
        if (file) {
            const formData = new FormData();
            formData.append('content_enc', text);
            formData.append('file', file);
            await fetch(window.location.href, {
                method: 'POST',
                body: formData
            });
            messageInput.value = '';
            fileInput.value = '';
            messageInput.style.height = 'auto';
            return;
        }
        // --- –®–∏—Ñ—Ä—É–µ–º —Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π ---
        let encrypted = text;
        if (anonymousMode && currentKey) {
            encrypted = await encryptMessage(text, currentKey);
        }
        socket.emit('send_message', {
            content: encrypted,
            recipient_id: otherUserId,
            sender_id: currentUserId
        });
        messageInput.value = '';
        messageInput.style.height = 'auto';
    });

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–∏ —Å–≤–æ–∏—Ö —Ç–æ–∂–µ)
    socket.on('new_message', async function(data) {
        if ((data.sender_id === otherUserId && data.recipient_id === currentUserId) ||
            (data.sender_id === currentUserId && data.recipient_id === otherUserId)) {
            let decryptedText = data.content;
            if (anonymousMode && currentKey) {
                decryptedText = await decryptMessage(data.content, currentKey);
            }
            const messageDiv = document.createElement('div');
            messageDiv.className = data.sender_id === currentUserId ? 'message sent' : 'message received';
            const now = new Date();
            const timeString = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
            messageDiv.innerHTML = `
                <div class="message-content">
                    <span class="message-text">${decryptedText}</span>
                    <span class="message-time">${timeString}</span>
                </div>
            `;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
    });
    
    // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
    if (messageInput) {
        messageInput.focus();
    }
    
    // –û—Ç–∫–ª—é—á–∞–µ–º—Å—è –æ—Ç –∫–æ–º–Ω–∞—Ç—ã –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('beforeunload', function() {
        socket.emit('leave_chat', {
            chat_id: chatId,
            user_id: currentUserId
        });
    });
</script>

<style>
.chat-header {
    display: flex;
    align-items: center;
    gap: 1em;
}
.chat-header-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    background: var(--bg-secondary);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}
.chat-header-avatar-img {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    object-fit: cover;
    background: var(--bg-secondary);
}
</style>
{% endblock %} 